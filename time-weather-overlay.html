<!DOCTYPE html>
<meta charset="utf-8">
<link href="https://fonts.googleapis.com/css2?family=Rye&display=swap" rel="stylesheet">

<style>
  :root{ --gold:#FFD700; --cycle-sec:6; }
  html,body{ margin:0; background:transparent; font-family:'Rye', cursive; }
  .stage{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; }
  .card{
    position:absolute; opacity:0; transition:opacity 600ms ease;
    color:var(--gold); font-weight:700; font-size:72px;
    text-shadow:2px 2px 4px #000; pointer-events:none; user-select:none; white-space:nowrap;
  }
  .sub{ font-size:28px; font-weight:700; margin-left:14px; opacity:0.9; }
  .show{ opacity:1; }
  @media (max-width: 700px){ .card{ font-size:54px; } .sub{ font-size:22px; } }

  /* optional on-screen debug */
  .dbg{ position:fixed; left:8px; bottom:8px; font:600 12px system-ui; color:#fff; background:#0009; padding:6px 8px; border-radius:8px; display:none; }
  .dbg.on{ display:block; }
</style>

<div class="stage">
  <div id="timeCard" class="card">--:--</div>
  <div id="tempCard" class="card">--°<span class="sub" id="tempUnit">C</span></div>
  <div id="goldCard" class="card">$—<span class="sub">/oz</span></div>
</div>
<div id="dbg" class="dbg"></div>

<script>
/* URL params: ?lat=64.06&lon=-139.43&units=C&tz=America/Whitehorse&cycle=6&debug=1 */
const p = new URLSearchParams(location.search);
const LAT   = parseFloat(p.get('lat') ?? '64.06');
const LON   = parseFloat(p.get('lon') ?? '-139.43');
const UNITS = (p.get('units') ?? 'C').toUpperCase();
const TZ    = p.get('tz') ?? 'America/Whitehorse';
const CYCLE = Math.max(4, parseInt(p.get('cycle') ?? '6', 10));
const DEBUG = p.get('debug') === '1';

const timeCard = document.getElementById('timeCard');
const tempCard = document.getElementById('tempCard');
const goldCard = document.getElementById('goldCard');
const tempUnit = document.getElementById('tempUnit');
const dbgEl    = document.getElementById('dbg');
if (DEBUG) dbgEl.classList.add('on');

function dbg(msg){ if (DEBUG) dbgEl.textContent = msg; }

/* Time */
function updateClock(){
  try{
    const now = new Date();
    timeCard.textContent = now.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", hour12:true, timeZone:TZ});
  }catch{ timeCard.textContent = '--:--'; }
}
setInterval(updateClock, 1000); updateClock();

/* Temperature */
async function fetchTemp(){
  try{
    const unitApi = UNITS === 'F' ? 'fahrenheit' : 'celsius';
    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current=temperature_2m&temperature_unit=${unitApi}&timezone=auto`, {cache:'no-store'});
    const data = await res.json();
    const t = Math.round(data?.current?.temperature_2m ?? NaN);
    tempUnit.textContent = UNITS;
    tempCard.firstChild.nodeValue = Number.isFinite(t) ? `${t}°` : `—°`;
  }catch{
    tempCard.firstChild.nodeValue = `—°`; tempUnit.textContent = UNITS;
  }
}
fetchTemp(); setInterval(fetchTemp, 5*60*1000);

/* Gold price (USD/oz) via Yahoo Finance through a CORS-safe proxy */
async function fetchGold(){
  try{
    // Yahoo spot gold (XAUUSD=X)
    const y = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent('XAUUSD=X')}`;
    const prox = `https://r.jina.ai/http/${encodeURIComponent(y)}`; // CORS-friendly proxy

    const res = await fetch(prox, { cache:'no-store' });
    const txt = await res.text();

    // Pull the number directly from the text (regex)
    // Look for: "regularMarketPrice":{"raw":<number>
    let m = txt.match(/"regularMarketPrice":\{"raw":([\d.]+)/);
    if (!m) {
      // fallback to previous close if market price missing
      m = txt.match(/"regularMarketPreviousClose":\{"raw":([\d.]+)/);
    }
    if (m) {
      const price = parseFloat(m[1]);
      if (isFinite(price)) {
        goldCard.innerHTML = `$${price.toFixed(2)}<span class="sub">/oz</span>`;
        dbg('gold: Yahoo via proxy');
        return;
      }
    }
    goldCard.innerHTML = `— <span class="sub">USD/oz</span>`;
    dbg('gold: Yahoo parse failed');
  }catch(e){
    goldCard.innerHTML = `— <span class="sub">USD/oz</span>`;
    dbg('gold: fetch failed');
  }
}
fetchGold(); setInterval(fetchGold, 5*60*1000);

/* Crossfade: time → temp → gold */
const cards = [timeCard, tempCard, goldCard];
let idx = 0;
function show(i){ cards.forEach((c, k) => c.classList.toggle('show', k === i)); }
show(0);
setInterval(() => { idx = (idx + 1) % cards.length; show(idx); }, CYCLE * 1000);
</script>
